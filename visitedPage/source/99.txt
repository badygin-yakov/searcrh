TM Feed Хабрахабр Geektimes Тостер Мой круг Фрилансим Мегапосты: Хабрахабр Публикации Пользователи Хабы Компании Песочница Войти Регистрация Forwolk сегодня в 16:39 JNI: Подружим Java и C++ Java, C++ Из песочницы Введение Бывают моменты, когда в Java некоторые действия выполняются за пределами обычных Java-классов. Например, необходимо исполнить код, написанный на C/C++ или другом каком-нибудь языке. В данной статье рассмотрим данный вопрос с практической точки зрения, а именно напишем простой пример взаимодействия кода Java с кодом C++, используя JNI. Статья не содержит чего-то сверхестественного, это скорее памятка для тех, кто с этим не работал. Для наших целей существует возможность динамической загрузки нативных библиотек, вызываемая методом System.load(), о чем более подробно можно прочитать здесь. Постановка задачи Пусть нам необходимо реализовать класс, содержащий в себе нативный метод, выводящий на экран “Hello world”. JNIHelloWorld.java package ru.forwolk.test;

public class JNIHelloWorld {
    native void printHelloWorld();
}
 Генерация заголовков Сгенерируем заголовки данного класса для C++. Сначала создадим папку в корне проекта, где будем собирать бинарники: mkdir bin Затем, скомпилируем наш класс в данную директорию javac -d bin/ src/ru/forwolk/test/JNIHelloWorld.java В папке bin у нас появился class-файл. Вернее, в bin/ru/forwolk/test/. Переидем в папку bin и сгенерируем заголовки. cd bin/
javah ru.forwolk.test.JNIHelloWorld
 Как видно, в нашей папке bin появился файл ru_forwolk_test_JNIHelloWorld.h. Для простоты переименуем его в JNIHelloWorld.h mv ru_forwolk_test_JNIHelloWorld.h JNIHelloWorld.h Открыв его, видим следующую картину: JNIHelloWorld.h
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class ru_forwolk_test_JNIHelloWorld */

#ifndef _Included_ru_forwolk_test_JNIHelloWorld
#define _Included_ru_forwolk_test_JNIHelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     ru_forwolk_test_JNIHelloWorld
 * Method:    printHelloWorld
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_ru_forwolk_test_JNIHelloWorld_printHelloWorld
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
 Реализация на C++ Создадим файл с исходниками JNIHelloWorld.cpp. Я для этой цели создал проект в Clion, в который вставил необходимый файл. Реализуем наш метод. JNIHelloWorld.cpp
#include <iostream>
#include "JNIHelloWorld.h"

JNIEXPORT void JNICALL Java_ru_forwolk_test_JNIHelloWorld_printHelloWorld
        (JNIEnv *, jobject) {
    std::cout << "Hello world!";
}
 Чтобы в Clion все работало корректно, необходимо в файл CMakeLists.txt добавить библиотеки Java: // Вместо $JAVA_HOME -- путь до Java
include_directories($JAVA_HOME/include)
include_directories($JAVA_HOME/include/linux)
link_directories($JAVA_HOME/include)
link_directories($JAVA_HOME/include/linux)
 Далее компилируем g++ -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -fPIC JNIHelloWorld.cpp -shared -o helloworld.so -Wl,-soname -Wl,--no-whole-archive Загрузка в Java В корневой папке проекта появился файл helloworld.so. Переместим его в папку bin/ проекта Java. Теперь необходимо загрузить нашу библиотеку. Хорошей практикой будет статическая загрузка библиотеки прямо в классе. Добавим загрузку прямо в класс JNIHelloWorld static {
    // $PROJECT_ROOT -- абсолютный путь до библиотеки
    System.load("$PROJECT_ROOT/bin/helloworld.so");
 }
 Теперь мы можем полноценно использовать данный класс. Давайте проверим. public static void main(String[] args) {
    JNIHelloWorld p = new JNIHelloWorld();
    p.printHelloWorld();
}
 На выходе получаем Hello world!
Process finished with exit source 0
 Передача параметров А что делать, если нам надо не только выполнять какой-то код, а также передавать параметры и получать ответ? Рассмотрим еще один метод, выполняющий умножение двух чисел. Добавим в класс JNIHelloWorld метод native int multiply(int a, int b);
 Выполняем те же самые действия, описанные выше по генерации заголовков. Как видим, сгенерировалось следующее /*
 * Class:     ru_forwolk_test_JNIHelloWorld
 * Method:    multiply
 * Signature: (II)I
 */
JNIEXPORT jint JNICALL Java_ru_forwolk_test_JNIHelloWorld_multiply
  (JNIEnv *, jobject, jint, jint);
 Реализуем метод в JNIHelloWorld.cpp JNIEXPORT jint JNICALL Java_ru_forwolk_test_JNIHelloWorld_multiply
        (JNIEnv *, jobject, jint a, jint b) {
    return a * b;
}
 Опять же произведем описанные выше действия по подтягиванию библиотеки, добавим строку в main по выводу результата произведения двух чисел и запустим public static void main(String[] args) {
    JNIHelloWorld p = new JNIHelloWorld();
    System.out.println(p.multiply(2, 2));
    p.printHelloWorld();
}
 Что получаем в консоли 4
Hello world!
Process finished with exit source 0
 Заключение Мы с вами рассмотрели возможность Java использовать код, написанный на C/C++. Это можно применять в различных целях, например, для увеличения скорости исполнения кода, для защиты кода от прямого вмешательства и для прочих целей. Очень надеюсь, что данная статья поможет вам разобраться в основах JNI. Весь код я выложил в открытый доступ. В директории cpp разместил класс C++ без лишних файлов проекта Clion. Дополнительная литература Также для большего кругозора по данной теме рекомендую обратить внимание на следующие статьи: JNI, загрузка нативных библиотек. Меняем java.library.path на лету Дорог ли native метод? «Секретное» расширение JNI Метки: java jni java native interface c++ tutorial Добавить метки Пометьте публикацию своими метками Метки необходимо разделять запятой. Например: php, javascript, андронный коллайдер, задача трех тел Сохранить AdBlock похитил этот баннер, но баннеры не зубы — отрастут Подробнее Реклама Читают сейчас Почему в 2018 году я использую метод разработки, которому уже 30 лет 12,9k 19 Firefox Gecko, «который мы потеряли» 5,8k 71 Как пользователи учат Яндекс предупреждать о телефонном спаме 9k 96 TDD ошибочно? 2,3k 2 Почему "=" означает присваивание? 4,8k 8 Приложения, достигшие самосознания: автоматизированная диагностика в продакшне 1,5k 0 AdBlock похитил этот баннер, но баннеры не зубы — отрастут Подробнее Реклама +6 26 1,4k 4 Выберите рекомендации для отправки автору: Указан только блог Орфографические ошибки Пунктуационные ошибки Отступы Текст-простыня Короткие предложения Смайлики Много форматирования Картинки Ссылки Оформление кода Рекламный характер Отправить Нарушение Опишите суть нарушения Отправить 1,0 Карма 4,8 Рейтинг 0 Подписчики Forwolk Пользователь Поделиться публикацией Похожие публикации 15 февраля 2014 в 13:40 Вопросы и задания для русскоязычной книги Thinking in Java (Философия Java) Брюса Эккеля +17 140k 371 21 2 октября 2012 в 01:20 Scala как расширенная Java или Java++ +28 22,1k 90 58 23 апреля 2011 в 19:25 JNI, загрузка нативных библиотек. Меняем java.library.path на лету +24 19,1k 49 14 Вакансии QA Engineer ArtStation Labs Казань Полный рабочий день от 50 000 до 80 000 IOS разработчик ArtStation Labs Казань Полный рабочий день от 70 000 до 120 000 Junior C#/.NET Developer Тенет Казань Полный рабочий день от 30 000 Java Developer Тенет Казань Полный рабочий день от 60 000 до 120 000 Frontend developer (фронтенд-разработчик) MyWed Рязань Полный рабочий день от 60 000 до 70 000 Все вакансии Разместить вакансию AdBlock похитил этот баннер, но баннеры не зубы — отрастут Подробнее Реклама Комментарии 4 staticlab 11.04.18 в 16:44 0 А для чего у вас CMake, если вы компилируете "вручную"? Forwolk 11.04.18 в 16:49 0 Лично я использую Clion для удобства разработки на плюсах. А там без внесения изменений в CMakeList.txt не подхватываются зависимости. Конечно, можно и без этого. staticlab 11.04.18 в 16:52 0 Теперь попробуйте создать из C++ Java-объект, вызвать в нём метод, а потом напишите ещё одну статью :) Akon32 11.04.18 в 17:30 +1 Не стыдно в 2018 про javah рассказывать? Только полноправные пользователи могут оставлять комментарии. Войдите, пожалуйста. Что обсуждают Сейчас Вчера Неделя Игра Snake в 93 байта 13,7k 21 Фреймворк для бессерверных приложений в AWS 1,9k 6 Для чего программисту Continuous Integration и с чего начинать 14,9k 42 Хакеры атаковали пользователей криптобиржи Poloniex с помощью поддельного мобильного приложения 667 2 Как пользователи учат Яндекс предупреждать о телефонном спаме 9k 96 Диванный вице-президент: как я работаю директором по продуктам на полной удалёнке 10,5k 132 Как пользователи учат Яндекс предупреждать о телефонном спаме 9k 96 Firefox Gecko, «который мы потеряли» 5,8k 71 Для чего программисту Continuous Integration и с чего начинать 14,9k 42 Применение сверточных нейронных сетей для задач NLP 10,5k 21 Как специалисты Google Adwords помогли мне выбросить 150 000 грн (около $6000) за месяц или почему я больше не буду… 49k 251 Мессенджеры, пора делать следующий шаг 30,2k 220 Почему я не подписываю соглашения о неконкуренции 32,7k 166 Диванный вице-президент: как я работаю директором по продуктам на полной удалёнке 10,5k 132 Осторожнее с копипастом: фингерпринтинг текста непечатаемыми символами 30,1k 93 Самое читаемое Сутки Неделя Месяц Почему в 2018 году я использую метод разработки, которому уже 30 лет +24 12,9k 56 19 История про блокчейн и немного про биткойны +24 10,8k 65 18 Для чего программисту Continuous Integration и с чего начинать +42 14,9k 220 42 Как пользователи учат Яндекс предупреждать о телефонном спаме +48 9k 18 96 Firefox Gecko, «который мы потеряли» +10 5,8k 15 71 Как специалисты Google Adwords помогли мне выбросить 150 000 грн (около $6000) за месяц или почему я больше не буду… +86 49k 123 251 Как я за 9 месяцев превратился из неофита в разработчика ПО без отрыва от основной работы +31 38k 305 38 Почему я не подписываю соглашения о неконкуренции +87 32,7k 84 166 Конференция DEFCON 23. «Как я сбивал назойливый дрон соседского ребёнка». Майкл Робинсон +60 30,7k 135 38 Мессенджеры, пора делать следующий шаг +18 30,2k 83 220 Как уже снова не получить телефон (почти) любой красотки в Москве, или интересная особенность MT_FREE +129 163k 260 101 Мы нашли крупную компанию, которая 5 лет не занималась информационной безопасностью, и она ещё жива +30 79k 119 97 Как Red Hat убила свой главный продукт и стала многомиллиардной корпорацией +89 67,4k 105 68 Дискредитация специалистов или современные собеседования +77 61,6k 153 675 [BugBounty] Раскрытие 5 миллионов ссылок в приватные чаты Telegram и возможность редактирования любой статьи telegra.ph +116 58k 172 66 Интересные публикации Хабрахабр Geektimes Обнаружена уязвимость в панели управления хостингом Vesta CP +5 222 3 0 Роскомнадзор продолжает уничтожать Интернет: настала очередь Google GT +9 4k 4 12 Имитация левитации воды на Ардуино GT +18 2,9k 14 16 Охота на Dofoil с помощью Windows Defender ATP +10 442 2 1 Лишать гарантии за оторванную наклейку или пломбу — незаконно GT +16 3,8k 7 1 TDD ошибочно? +22 2,3k 28 2 Журналисты нашли в Москве 11 пунктов обмена криптовалюты и 4 биткоин-банкомата +7 1,6k 3 2 JNI: Подружим Java и C++ +6 1,4k 26 4 Новый апдейт iOS сделал неоригинальные экраны «восьмерок» неработоспособными GT +24 10,3k 7 37 Apple заставят заплатить $500 млн патентному троллю GT +8 5,6k 3 6 AdBlock похитил этот баннер, но баннеры не зубы — отрастут Подробнее Реклама Аккаунт Войти Регистрация Разделы Публикации Хабы Компании Пользователи Песочница Информация Правила Помощь Документация Соглашение Конфиденциальность Услуги Реклама Тарифы Контент Семинары Приложения © 2006 – 2018 «TM» О сайте Служба поддержки Мобильная версия
