TM Feed Хабрахабр Geektimes Тостер Мой круг Фрилансим Хабрахабр Публикации Пользователи Хабы Компании Песочница Войти Регистрация Microsoft 485,31 Microsoft — мировой лидер в области ПО и ИТ-услуг sahsAGU 21 марта в 11:24 Срыв масштабной хакерской атаки на пользователей Windows в России: часть 2 https://cloudblogs.microsoft.com/microsoftsecure/2018/03/13/poisoned-peer-to-peer-app-kicked-off-dofoil-coin-miner-outbreak/ Разработка под Windows, Машинное обучение, Информационная безопасность, Антивирусная защита, Блог компании Microsoft Перевод Совсем недавно мы предотвратили массовую атаку с применением трояна Dofoil, целью которой была установка вредоносного ПО для майнинга криптовалют на сотни тысяч компьютеров. С помощью поведенческого мониторинга, моделей машинного обучения и многоуровневой системы защиты антивирусная программа Windows Defender смогла эффективно выявить и заблокировать атаку в течение несколько миллисекунд. Сегодня мы еще подробнее расскажем о самой атаке, путях заражения и поделимся временно́й шкалой. Заглядывайте под кат! Сразу после обнаружения атаки мы смогли определить, откуда именно совершается огромное количество попыток установить вредоносное ПО. Как правило, троян Dofoil (также известный как Smoke Loader) распространяется самыми разными способами, включая спам-сообщения и наборы эксплойтов. Для атаки, которая началась 6 марта, использовалась другая схема: большинство вредоносных файлов создавалось процессом mediaget.exe. Этот процесс относится к MediaGet, BitTorrent-клиенту, соответствующему классификации семейств потенциально нежелательных приложений. Пользователи часто используют приложение MediaGet для поиска и загрузки программ и мультимедийных файлов с сайтов с сомнительной репутацией. Использование таких приложений для файлообмена повышает риск загрузки вредоносных программ. Однако, изучив атаку, мы пришли к выводу, что заражение криптомайнером Dofoil не связано с загрузкой torrent-файлов. Ранее мы не наблюдали такую схему в других файлообменных приложениях. Процесс mediaget.exe всегда записывал образцы Dofoil в папку %TEMP% с именем my.dat. Наиболее часто источником заражения был файл %LOCALAPPDATA%\MediaGet2\mediaget.exe (SHA-1: 3e0ccd9fa0a5c40c2abb40ed6730556e3d36af3c). Рекомендуемые материалы: статистические данные об атаке, полезные сведения и данные о реагировании Windows Defender см. в статье Срыв масштабной хакерской атаки на пользователей Windows в России. Временная шкала осуществленной атаки Всестороннее изучение атаки Dofoil, предпринятой 6 марта, показало, что это была тщательно спланированная кампания, которая готовилась злоумышленниками с середины февраля. Для осуществления задуманного злоумышленники сначала распространили вирус через обновление программы MediaGet, которую пользователи установили на свои компьютеры. Временная шкала ниже отображает основные события в рамках атаки Dofoil. Рис. 1. Временная шкала атаки через MediaGet Заражение обновления программы MediaGet Процесс заражения обновления для MediaGet, которое в итоге привело к массовой атаке, описано в следующей схеме. Доверенное приложение mediaget.exe загружает исполняемый файл update.exe и запускает его на компьютере для установки нового экземпляра mediaget.exe. Новый экземпляр приложения mediaget.exe имеет все те же функции, что и подлинный, однако при этом в нем предусмотрена лазейка. Рис. 2. Процедура заражения файла обновления Вся процедура установки инфицированного файла обновления отслеживается сервисом Windows Defender ATP. Следующее дерево процессов показывает, как процесс mediaget.exe внедряет зараженный подписанный файл update.exe. Рис. 3. Обнаружение вредоносного процесса обновления в Windows Defender ATP Зараженный файл update.exe Загруженный update.exe представляет собой пакетный файл InnoSetup SFX, в который встроен зараженный трояном файл mediaget.exe. При запуске этот исполняемый файл внедряет зараженную трояном неподписанную версию приложения mediaget.exe. Рис. 4. Данные сертификата зараженного файла update.exe Update.exe подписан сторонним разработчиком ПО, не связанным с MediaGet (вполне вероятно, что эта компания является жертвой злоумышленников). Исполняемый файл содержит код, подписанный другим сертификатом, задача которого — просто передать такое же требование о подтверждении подписи, как и в исходном файле mediaget.exe. Код обновления выполняет проверку данных сертификата, подтверждая, что он является действительным и подписан надлежащим образом. Если сертификат подписан, он проверяет, совпадает ли значение хэша со значением, полученным от хэш-сервера в инфраструктуре mediaget.com. На следующей иллюстрации показан фрагмент кода, который выполняет проверку действительных подписей для файла update.exe. Рис. 5. Код обновления mediaget.exe Зараженный трояном файл mediaget.exe Зараженный трояном файл mediaget.exe, распознанный антивирусом Windows Defender AV как Trojan:Win32/Modimer.A, выполняет те же функции, что и исходный файл, однако он не подписан и имеет лазейку. Этот вредоносный двоичный код на 98 % совпадает с исходным двоичным кодом MediaGet. Согласно следующим данным PE, в исполняемом файле указаны другие данные PDB и иной путь файла. Рис. 6. Сравнение путей PDB подписанного и зараженного трояном исполняемого файла При запуске вредоносной программы создается список серверов управления и контроля (C&C). Рис. 7. Список серверов C&C Что касается встроенного списка C&C, важно отметить, что домен верхнего уровня .bit не является доменом, утвержденным ICANN, и поддерживается инфраструктурой NameCoin. NameCoin представляет собой распределенную систему альтернативных корневых серверов DNS, в которой реализован принцип блокчейн-моделей. Эта система предоставляет анонимные домены. Поскольку доменные имена .bit не разрешаются стандартными DNS-серверами, вредоносное ПО встраивает список из 71 адресов IPv4, которые используются как DNS-серверы NameCoin. Затем вредоносная программа использует серверы NameCoin для DNS-поиска по доменам .bit. С этого момента данные имена помещаются в DNS-кэш компьютера и все операции поиска в будущем разрешаются без указания DNS-серверов NameCoin. Первое обращение к серверу C&C происходит спустя один час после запуска программы. Рис. 8. Таймер начала подключения к серверу C&C Вредоносная программа выбирает один из четырех серверов C&C. Программа использует протокол HTTP для обмена данными управления и контроля. Рис. 9. Подключение к серверу C&C Код лазейки собирает сведения о системе и отправляет их на сервер C&C через POST-запрос. Рис. 10. Сведения о системе Сервер C&C возвращает на клиент различные команды. Следующий ответ содержит команды HASH, IDLE и OK. Команда IDLE задает ожидание процесса в течение определенного периода (в секундах, например — 7200 секунд = 2 часа) до повторного обращения к серверу C&C. Рис. 11. Команды управления и контроля Одна из команд лазейки — RUN, которая получает URL-адрес из командной строки сервера C&C. Затем вредоносное ПО загружает файл с URL-адреса, сохраняет его в папку %TEMP%\my.dat и запускает его. Рис. 12. Код обработки команды RUN Эта команда RUN использовалась для распространения трояна Dofoil, начиная с 1 марта, и в рамках атаки, предпринятой 6 марта. Дерево процессов оповещения Windows Defender ATP демонстрирует обмен данными между вредоносным процессом mediaget.exe и goshan.online, одним из подтвержденных серверов C&C. После этого программа внедряет и запускает файл my.dat (Dofoil), который в итоге ведет к компоненту CoinMiner. Рис. 13. Dofoil, процесс загрузки и выполнения CoinMiner Рис. 14. Дерево процессов системы оповещения Windows Defender ATP В рамках атаки троян Dofoil использовался для доставки вредоносной программы CoinMiner, задача которой — использовать ресурсы компьютеров пользователей для майнинга криптовалют в пользу злоумышленников. Троян Dofoil при атаке использовал изощренные приемы внедрения вредоносного кода в адресное пространство процессов, механизмы обеспечения устойчивости и методы уклонения от обнаружения. Windows Defender ATP успешно обнаруживает такое поведение на всех этапах заражения. Рис. 15. Обнаружение внедрения процесса Dofoil в Windows Defender ATP Мы сообщили о результатах наших исследований разработчикам MediaGet, чтобы помочь им грамотно проанализировать инцидент. Мы также рассказали владельцам сертификата о том, как их сертификат подписи кода используется злоумышленниками в файле update.exe (отпечаток: 5022EFCA9E0A9022AB0CA6031A78F66528848568). Защита от вирусных атак в режиме реального времени Тщательно спланированная и заранее подготовленная кампания с применением Dofoil, обнаруженная 6 марта, представляет собой яркий пример многоуровневой вирусной кибератаки, которые сегодня происходят все чаще. При совершении типовых киберпреступлений теперь используются все более сложные приемы, которые ранее ассоциировались с более изощренными кибератаками. Windows Defender Advanced Threat Protection (Windows Defender ATP) предоставляет расширенный набор инструментов безопасности нового поколения, которые обеспечивают защиту клиентов в реальном времени от самых разных видов атак. Корпоративные клиенты, использующие антивирус Windows Defender AV, активировавшие функцию защиты от потенциально ненадежных приложений, были защищены от ПО MediaGet, зараженного трояном, которое оказалось источником вирусной атаки 6 марта. Windows Defender AV обеспечил надежную защиту клиентов от атак с применением Dofoil. Технологии поведенческого мониторинга и анализа выявили необычный механизм стойкости Dofoil и сразу же отправили соответствующий сигнал в облачную службу защиты, где многочисленные модели машинного обучения мгновенно блокировали большинство обнаруженных угроз при их появлении. Всесторонний анализ атаки также показал, что расширенные библиотеки обнаружения в Windows Defender ATP помечали вредоносное поведение Dofoil на всех этапах заражения. К вредоносному поведению можно отнести внедрение кода, методы защиты от обнаружения и внедрение компонентов для майнинга криптовалют. Специалисты по безопасности могут использовать платформу Windows Defender ATP для обнаружения атак и эффективного реагирования на них. Windows Defender ATP также предоставляет встроенные инструменты защиты Windows Defender AV, Windows Defender Exploit Guard и Windows Defender Application Guard, обеспечивая безупречное управление системой безопасности на всех уровнях. Индикаторы компрометации (IOCs) Имя файла SHA-1 Описание Подписывающая сторона Дата подписания Имя обнаруженной вредоносной программы mediaget.exe 1038d32974969a1cc7a79c3fc7b7a5ab8d14fd3e Официальный исполняемый файл mediaget.exe GLOBAL MICROTRADING PTE. LTD. 2:04 PM 10/27/2017 PUA:Win32/MediaGet mediaget.exe 4f31a397a0f2d8ba25fdfd76e0dfc6a0b30dabd5 Официальный исполняемый файл mediaget.exe GLOBAL MICROTRADING PTE. LTD. 4:24 PM 10/18/2017 PUA:Win32/MediaGet update.exe 513a1624b47a4bca15f2f32457153482bedda640 Зараженный трояном исполняемый файл обновления DEVELTEC SERVICES SA DE CV – Trojan:Win32/Modimer.A mediaget.exe 3e0ccd9fa0a5c40c2abb40ed6730556e3d36af3c, fda5e9b9ce28f62475054516d0a9f5a799629ba8 Зараженный трояном исполняемый файл mediaget.exe Не подписан – Trojan:Win32/Modimer.A my.dat d84d6ec10694f76c56f6b7367ab56ea1f743d284 Внедренный вредоносный исполняемый файл – – TrojanDownloader:Win32/Dofoil.AB wuauclt.exe 88eba5d205d85c39ced484a3aa7241302fd815e3 Внедренная программа CoinMiner – – Trojan:Win32/CoinMiner.D Метки: Windows Windows Defender Dofoil информационная безопасность уязвимости кибератаки Добавить метки Пометьте публикацию своими метками Метки необходимо разделять запятой. Например: php, javascript, андронный коллайдер, задача трех тел Сохранить +30 31 14,4k 10 Нарушение Опишите суть нарушения Отправить Выберите рекомендации для отправки автору: Указан только блог Орфографические ошибки Пунктуационные ошибки Отступы Текст-простыня Короткие предложения Смайлики Много форматирования Картинки Ссылки Оформление кода Рекламный характер Отправить Microsoft 485,31 Microsoft — мировой лидер в области ПО и ИТ-услуг 18,5 Карма 165,6 Рейтинг 27 Подписчики Александр Гуреев sahsAGU Пользователь Facebook Twitter Вконтакте Github Поделиться публикацией Похожие публикации 16 октября 2015 в 16:15 Windows Camp //Labs — как научиться разрабатывать универсальные приложения Windows 10 за один день +6 10,1k 42 4 30 апреля 2015 в 01:09 Build 2015: Visual Studio для OS X и Linux, Windows 10, облачные сервисы и другие новинки от Microsoft +48 92,1k 106 67 25 августа 2011 в 17:29 Эксперт по информационной безопасности Томас Шиндер посетит Москву и выступит на Tech∙Ed Russia 2011 +14 2,6k 1 9 Комментарии 10 vilgeforce 21.03.18 в 13:51 0 Как, кстати, кросавчеги из Mediaget на это все отреагировали? rt3879439 21.03.18 в 15:51 +2 Всегда считал mediaget малварью. jeka1202 22.03.18 в 14:36 0 она как мальварь и задумывалась скорее всего. LuckyStarr 23.03.18 в 06:04 0 Уж много лет, если встречал у кого mediaget, то сразу предупреждал, чтоб готовились к неожиданностям. Как был малварью, так и остался. evgesha3215 21.03.18 в 17:07 –1 Подскажите как защитится от этой атаки, я по факту понимаю что типа это было направленно по сегментам сети в частности (mediaget) Еще такой вопрос как смотреть что куда ходит по сети кроме огромного wireshark? Dywar 21.03.18 в 19:37 0 1) Sysinternals Suite (tcp view) 2) Firewall с логгированием. 3) www.snort.org и подобные. Это сходу что в голову пришло, больше на лубых курсах по ИБ. PentestIt например. CoolMind 22.03.18 в 12:14 0 Не совсем понял, почему атака производилась, в основном, на Россию, а не на Windows с русской локалью, например? Lossy 22.03.18 в 19:06 0 Статистика посещений сайта mediaget.com почти 1 в 1 повторяет карту из КДПВ www.alexa.com/siteinfo/mediaget.com Leljka 22.03.18 в 23:31 0 Этот процесс относится к MediaGet неужели еще кто-то этим пользуется вообще??? И даже здесь?! Подскажите как защитится от этой атаки, я по факту понимаю что типа это было направленно по сегментам сети в частности (mediaget). Не пользоваться))) Он так жизненно необходим? Ну и очистить вышеуказанные папки, отключив вышеуказанные процессы. И уж коль стоковый антивирь справляется… Наивненько как-то, но спасибо. Судя по статистике — масса людей этим пользуется (хотя я не понимаю, зачем))) SeregaSA73 27.03.18 в 17:08 0 Просто люди пытаются скачать фильм или песню а им предлагается сделать это с помощью MediaGet, вот они не думая и нажимают Ок. Только полноправные пользователи могут оставлять комментарии. Войдите, пожалуйста. Информация Дата основания 04 апреля 1975 Локация США Сайт microsoft.com Численность Неизвестно Дата регистрации 09 августа 2008 Виджет Facebook Twitter Читать @msdevru ВКонтакте Виджет https://telegram.me/msdnru Канал Microsoft Developer в Telegram Виджет Новости Microsoft инвестирует 5 млрд долларов в Интернет вещей 6 апреля 2018 14 апреля. Состоится российский финал международного технологического конкурса студенческих проектов Imagine Cup 2018 3 апреля 2018 14 апреля. Состоится российский финал международного технологического конкурса студенческих проектов Imagine Cup 2018 3 апреля 2018 17-18 апреля. Бесплатная онлайн-конференция. Платформа данных 28 марта 2018 17-18 апреля. Бесплатная онлайн-конференция. Платформа данных 28 марта 2018 Анонсирована предварительная версия Windows Server 2019! 26 марта 2018 27-29 марта. Серия вебинаров. Размещение веб-приложений и сайтов в Microsoft Azure 22 марта 2018 27-29 марта. Серия вебинаров. Размещение веб-приложений и сайтов в Microsoft Azure 22 марта 2018 30 марта. Вебинар. Windows as a Service: новая модель развертывания и обслуживания клиентских рабочих мест 22 марта 2018 13 апреля. Вебинар. Mobile DevOps на практике 22 марта 2018 Виджет Ссылки Канал Microsoft Developer в Telegram telegram.me Канал Microsoft Developer на YouTube www.youtube.com Microsoft Virtual Academy mva.microsoft.com Channel 9 channel9.msdn.com Microsoft для стартапов в Facebook www.facebook.com Портал для разработчиков developer.microsoft.com Виджет Блог на Хабрахабре Охота на Dofoil с помощью Windows Defender ATP 455 1 А у нас будет настоящий космонавт! На Imagine Cup 2018 1,5k 3 Sysmon для безопасника. Расширяем возможности аудита событий в Windows 3,6k 3 Квантовые цепи и вентили — вводный курс 4,1k 27 Как заменить HR-a роботом? Техническая часть 2,3k 0 Как пользоваться Azure бесплатно (лайфхак для студентов) 11,5k 18 Нужны ли миру технические сертификаты? 4,9k 15 Стриминг видео с помощью Azure и .NET 2k 2 Введение в квантовые вычисления 5,6k 6 Теперь я тебя вижу: выявление бесфайловых вредоносных программ 11k 8 Самое читаемое Сутки Неделя Месяц Почему в 2018 году я использую метод разработки, которому уже 30 лет +24 12,9k 56 19 История про блокчейн и немного про биткойны +24 10,8k 65 18 Для чего программисту Continuous Integration и с чего начинать +42 14,9k 220 42 Как пользователи учат Яндекс предупреждать о телефонном спаме +48 9k 18 96 Firefox Gecko, «который мы потеряли» +10 5,8k 15 71 Как специалисты Google Adwords помогли мне выбросить 150 000 грн (около $6000) за месяц или почему я больше не буду… +86 49k 123 251 Как я за 9 месяцев превратился из неофита в разработчика ПО без отрыва от основной работы +31 38k 305 38 Почему я не подписываю соглашения о неконкуренции +87 32,7k 84 166 Конференция DEFCON 23. «Как я сбивал назойливый дрон соседского ребёнка». Майкл Робинсон +60 30,7k 135 38 Мессенджеры, пора делать следующий шаг +18 30,2k 83 220 Как уже снова не получить телефон (почти) любой красотки в Москве, или интересная особенность MT_FREE +129 163k 260 101 Мы нашли крупную компанию, которая 5 лет не занималась информационной безопасностью, и она ещё жива +30 79k 119 97 Как Red Hat убила свой главный продукт и стала многомиллиардной корпорацией +89 67,4k 105 68 Дискредитация специалистов или современные собеседования +77 61,6k 153 675 [BugBounty] Раскрытие 5 миллионов ссылок в приватные чаты Telegram и возможность редактирования любой статьи telegra.ph +116 58k 172 66 Интересные публикации Хабрахабр Geektimes Обнаружена уязвимость в панели управления хостингом Vesta CP +5 222 3 0 Роскомнадзор продолжает уничтожать Интернет: настала очередь Google GT +9 4k 4 12 Имитация левитации воды на Ардуино GT +18 2,9k 14 16 Охота на Dofoil с помощью Windows Defender ATP +10 442 2 1 Лишать гарантии за оторванную наклейку или пломбу — незаконно GT +16 3,8k 7 1 TDD ошибочно? +22 2,3k 28 2 Журналисты нашли в Москве 11 пунктов обмена криптовалюты и 4 биткоин-банкомата +7 1,6k 3 2 JNI: Подружим Java и C++ +6 1,4k 26 4 Новый апдейт iOS сделал неоригинальные экраны «восьмерок» неработоспособными GT +24 10,3k 7 37 Apple заставят заплатить $500 млн патентному троллю GT +8 5,6k 3 6 Аккаунт Войти Регистрация Разделы Публикации Хабы Компании Пользователи Песочница Информация Правила Помощь Документация Соглашение Конфиденциальность Услуги Реклама Тарифы Контент Семинары Приложения © 2006 – 2018 «TM» О сайте Служба поддержки Мобильная версия
